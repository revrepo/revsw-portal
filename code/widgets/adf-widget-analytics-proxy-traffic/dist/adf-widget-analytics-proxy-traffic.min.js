!function(t,e){"use strict";function i(t,e,i,a){"ngInject";function o(t){var e={from_timestamp:moment().subtract(1,"hours").valueOf(),to_timestamp:Date.now()};return _.forEach(t,function(t,i){-1!==_.indexOf(n,i)?"-"!==t&&""!==t&&(e[i]=t):"count_last_hours"===i&&(e.from_timestamp=moment().subtract(t,"hours").valueOf(),e.to_timestamp=Date.now(),delete e.count_last_hours)}),e}var n=["domainId","from_timestamp","to_timestamp","country"],s={filters:{count_last_hours:"1",country:"-"},info:{country:"All countries"}};_.defaultsDeep(t.config,s),i.query().$promise.then(function(e){t.countries=e,t.reload()}),t.reload=function(){if(t.config.domain){var e={domainId:t.config.domain.id,country:t.config.filters.country,count_last_hours:t.config.filters.count_last_hours||"1"};t.reloadRequestStatus(e)}},t.reloadRequestStatus=function(e){t.requestStatus=[],a.requestStatus(o(e)).$promise.then(function(e){if(e.data&&e.data.length>0){var i=[{name:"Successfull",y:0},{name:"Failed",y:0}];angular.forEach(e.data,function(t){"OK"===t.key?i[0].y=t.count:i[1].y+=t.count}),t.requestStatus=i}})}}angular.module("adf.widget.analytics-proxy-traffic",["adf.provider"]).config(["dashboardProvider",function(t){function e(t,e,i,a){"ngInject";t.onDomainSelected=function(){t.domain&&t.domain.id&&t.reload()},t.reload=function(){angular.extend(t.config,{domain:angular.copy(t.domain)})}}function i(t,e,i,a,o,n,s){"ngInject";var l={filters:{count_last_hours:"6"}};_.defaultsDeep(t.config,l),t.elId=(new Date).getTime(),t._loading=!0,n.query().$promise.then(function(e){t.reload(),t.countries=e}),t.reload=function(){if(t.config.domain){var e={domainId:t.config.domain.id,count_last_hours:t.config.filters.count_last_hours||"6",from_timestamp:moment().subtract(t.config.filters.count_last_hours,"hours").valueOf(),to_timestamp:Date.now()};t.reloadGBTCountry(e).then(function(){s.drawMap("#canvas-svg-gbt"+t.elId,"#tooltip-container-gbt"+t.elId,t.countryGBTData)})["finally"](function(){t._loading=!1})}},t.reloadGBTCountry=function(e){return s.clearMap("#canvas-svg-gbt"+t.elId),t._loading=!0,t.countryGBTData={},o.gbt_country({domainId:e.domainId,count:250,from_timestamp:moment().subtract(e.count_last_hours||"6","hours").valueOf(),to_timestamp:Date.now()}).$promise.then(function(e){return e.data&&e.data.length>0&&angular.forEach(e.data,function(e){var i=t.countries[e.key.toUpperCase()]||e.key;t.countryGBTData[i]={value:e.sent_bytes,tooltip:"Sent: <strong>"+s.valueFormat(e.sent_bytes,"G")+"B</strong> Received: <strong>"+s.valueFormat(e.received_bytes,"G")+"B</strong>"}}),e})}}function a(t,e,i,a,o){"ngInject";var n={filters:{count_last_hours:"1",country:"-"},info:{country:"All countries"}};_.defaultsDeep(t.config,n),a.query().$promise.then(function(e){t.refCountries=e}),t.onDomainSelected=function(){t.domain&&t.domain.id&&t.reload()},t.reload=function(){angular.extend(t.config,{domain:angular.copy(t.domain)})},t.$watch("config.filters",function(e,i){e&&e.country&&angular.extend(t.config.info,{country:t.refCountries[e.country.toUpperCase()]||e.country.toUpperCase()})},!0)}function o(t,e,i){"ngInject";function a(t){var e={from_timestamp:moment().subtract(1,"hours").valueOf(),to_timestamp:Date.now()};return _.forEach(t,function(t,i){-1!==_.indexOf(o,i)?"-"!==t&&""!==t&&(e[i]=t):"count_last_hours"===i&&(e.from_timestamp=moment().subtract(t,"hours").valueOf(),e.to_timestamp=Date.now(),delete e.count_last_hours)}),e}var o=["domainId","from_timestamp","to_timestamp","country"],n={filters:{count_last_hours:"1",country:"-"},info:{country:"All countries"}};_.defaultsDeep(t.config,n),e.query().$promise.then(function(e){t.countries=e,t.reload()}),t.reload=function(){if(t.config.domain){var e={domainId:t.config.domain.id,country:t.config.filters.country,count_last_hours:t.config.filters.count_last_hours||"6"};t.reloadTopReportCountry(e)}},t.country=[],t.reloadTopReportCountry=function(e){i.country(a(e)).$promise.then(function(e){t.country.lenght=0,e.data&&e.data.length>0&&angular.forEach(e.data,function(e){var i=t.countries[e.key.toUpperCase()]||e.key;t.country.push({name:i,y:e.count})})})}}var n={title:"Proxy Traffic",description:"Web Alalytics Proxy Traffic",titleTemplateUrl:"parts/dashboard/widgets/proxy-traffic/widget-title-with-params-proxy-traffic.html",templateUrl:"{widgetsPath}/analytics-proxy-traffic/src/view.html",editTemplateUrl:"parts/dashboard/widgets/widget-edit.html",styleClass:"rev-widget",controller:["$scope","$window",function(t,e,i){e.dispatchEvent(new Event("resize"));var a={filters:{country:"-",os:"-",device:"-",count_last_day:"1"}};_.defaultsDeep(t.config,a)}],edit:{templateUrl:"parts/dashboard/widgets/proxy-traffic/edit-proxy-traffic.html",controller:["$scope","$q","Stats","Countries","User","AlertService",function(t,e,i,a,o,n){var s=(angular.copy(t.config),{filters:{country:"-",os:"-",device:"-",count_last_day:"1"},info:{country:"All countries"}});_.defaultsDeep(t.config,s),t.$watch("config.filters",function(e,i){e&&e.country&&angular.extend(t.config.info,{country:t.flCountry[e.country.toUpperCase()]||e.country.toUpperCase()})},!0),t.onDomainSelected=function(){t.domain&&t.domain.id&&t.reload()},t.reload=function(){angular.extend(t.config,{domain:angular.copy(t.domain)}),t.reloadCountry(t.domain.id),t.reloadOS(t.domain.id),t.reloadDevice(t.domain.id),t.reloadStatusCode(t.domain.id)},t.flCountry={},t.reloadCountry=function(e){t.flCountry=a.query()},t.flOs={labels:[],data:[]},t.reloadOS=function(e){i.os({domainId:e}).$promise.then(function(e){t.flOs.labels.length=0,t.flOs.data.length=0,e.data&&e.data.length>0&&angular.forEach(e.data,function(e){t.flOs.labels.push(e.key),t.flOs.data.push(e.count)})})},t.flDevice={labels:[],data:[]},t.reloadDevice=function(e){i.device({domainId:e}).$promise.then(function(e){t.flDevice.labels.length=0,t.flDevice.data.length=0,e.data&&e.data.length>0&&angular.forEach(e.data,function(e){t.flDevice.labels.push(e.key),t.flDevice.data.push(e.count)})})},t.statusCode={labels:[],data:[]},t.reloadStatusCode=function(e){return i.statusCode({domainId:e}).$promise.then(function(e){t.statusCode.labels.length=0,t.statusCode.data.length=0,e.data&&e.data.length>0&&(angular.forEach(e.data,function(e){t.statusCode.labels.push(e.key),t.statusCode.data.push(e.count)}),t.config.statusCode=t.statusCode.labels)})},o.getUserDomains(!0)}]}};t.widget("analytics-proxy-traffic-bandwidth-usage",angular.extend(n,{title:"Bandwidth Usage",description:"Display the Bandwidth Usage",templateUrl:"{widgetsPath}/analytics-proxy-traffic/src/views/view-requests-chart.tpl.html"})).widget("analytics-proxy-traffic-chart",angular.extend(n,{title:"Total Requests",description:"Display Total Requests Graph",templateUrl:"{widgetsPath}/analytics-proxy-traffic/src/views/view-proxy-traffic-chart.tpl.html"})).widget("analytics-proxy-traffic-http-https-chart",angular.extend(n,{title:"HTTP/HTTPS Hits",description:"Display the HTTP/HTTPS Hits",templateUrl:"{widgetsPath}/analytics-proxy-traffic/src/views/view-http-https-chart.tpl.html"})).widget("analytics-proxy-hits-cache-chart",angular.extend(n,{title:"Edge Cache Efficiency Hits",description:"Display Cache Hit/Miss Graph",templateUrl:"{widgetsPath}/analytics-proxy-traffic/src/views/view-hits-cache-chart.tpl.html"})).widget("adf-widget-gbt-heatmaps",{title:"GBT Heatmap",titleTemplateUrl:"parts/dashboard/widgets/heatmaps/widget-title-with-params-heatmap.html",description:"Global Traffic Heatmaps - GBT Heatmap",templateUrl:"parts/dashboard/widgets/heatmaps/view-gbt-heatmaps.tpl.html",controller:i,edit:{templateUrl:"parts/dashboard/widgets/heatmaps/edit-heatmap.html",controller:e}}).widget("adf-widget-top-10-countries",{title:"Top 10 Countries",titleTemplateUrl:"parts/dashboard/widgets/top-reports/widget-title-with-params-top-reports.html",description:"Top Proxy Traffic Reports - Top 10 Countries",templateUrl:"parts/dashboard/widgets/top-reports/view-top-10-countries.tpl.html",controller:o,edit:{templateUrl:"parts/dashboard/widgets/top-reports/edit-top-reports.html",controller:a}}).widget("adf-widget-http-https-requests-ratio",{title:"Request Success/Failure Ratio",description:"Display Pie Chart For Request Completion Success/Failure Ratio",titleTemplateUrl:"parts/dashboard/widgets/top-reports/widget-title-with-params-top-reports.html",templateUrl:"parts/dashboard/widgets/top-reports/view-request-success-fialure-ratio.tpl.html",controller:"widgetRequestSuccessFailureRatioCtrl",edit:{templateUrl:"parts/dashboard/widgets/top-reports/edit-top-reports.html",controller:a}}),e.$inject=["$scope","$window","$timeout","Stats"],i.$inject=["$scope","$q","$window","$timeout","Stats","Countries","HeatmapsDrawer"],a.$inject=["$scope","$window","$timeout","Countries","Stats"],o.$inject=["$scope","Countries","Stats"]}]),angular.module("adf.widget.analytics-proxy-traffic").run(["$templateCache",function(t){t.put("{widgetsPath}/analytics-proxy-traffic/src/edit.html",'<form role=form><div class=form-group><label for=domain>Domain</label><div domain-select id=domain ng-model=domain on-select=onDomainSelected() select-one=true></div></div><div class=form-group><label for=domain>Filters</label>{{config.filters}}</div><div class=form-inline><div class=form-group><select id=country class="form-control fixed" ng-model=config.filters.country ng-disabled=!domain><option value=->All Countries</option><option ng-repeat="(key, item) in flCountry" value={{key}}>{{item}}</option></select></div><div class=form-group><select id=os class="form-control fixed" ng-model=config.filters.os ng-disabled=!domain><option value=->All OS</option><option ng-repeat="item in flOs.labels" value={{item}}>{{item}}</option></select></div><div class=form-group><select id=device class="form-control fixed" ng-model=config.filters.device ng-disabled=!domain><option value=->All Devices</option><option ng-repeat="item in flDevice.labels" value={{item}}>{{item}}</option></select></div></div><div class=form-group><label for=domain>Time Period</label></div><div class=form-group></div></form>'),t.put("{widgetsPath}/analytics-proxy-traffic/src/view.html","<div><h1>Widget view</h1><p>Content of {{config.sample}}</p></div>"),t.put("{widgetsPath}/analytics-proxy-traffic/src/widget-edit.html",'<form name=widgetEditForm novalidate role=form ng-submit=saveDialog()><div class=modal-header><button type=button class=close ng-click=closeDialog() aria-hidden=true>&times;</button><h4 class=modal-title>{{widget.title}}</h4></div><div class=modal-body><div class="alert alert-danger" role=alert ng-show=validationError><strong>Apply error:</strong> {{validationError}}</div><div ng-if=widget.edit><adf-widget-content model=definition content=widget.edit></adf-widget-content></div></div><div class=modal-footer><button type=button class="btn btn-default" ng-click=closeDialog()>Cancel</button> <input type=submit class="btn btn-primary" ng-disabled=widgetEditForm.$invalid value=Apply></div></form>'),t.put("{widgetsPath}/analytics-proxy-traffic/src/widget-title-with-params.html",'<h3 class=panel-title>{{definition.title}} <span ng-if=!!definition.config.domain>(<strong>{{definition.config.domain.domain_name}}</strong>)</span> <span class=pull-right><a title="reload widget content" ng-if=widget.reload ng-click=reload()><i class="glyphicon glyphicon-refresh"></i></a> <a title="Change Widget Location" class=adf-move ng-if=editMode><i class="glyphicon glyphicon-move"></i></a> <a title="Collapse Widget" ng-show="options.collapsible && !widgetState.isCollapsed" ng-click="widgetState.isCollapsed = !widgetState.isCollapsed"><i class="glyphicon glyphicon-minus"></i></a> <a title="Expand Widget" ng-show="options.collapsible && widgetState.isCollapsed" ng-click="widgetState.isCollapsed = !widgetState.isCollapsed"><i class="glyphicon glyphicon-plus"></i></a> <a title="Edit Widget Configuration" ng-click=edit() ng-if=editMode><i class="glyphicon glyphicon-cog"></i></a> <a title="Fullscreen Widget" ng-click=openFullScreen() ng-show=options.maximizable><i class="glyphicon glyphicon-fullscreen"></i></a> <a title="Remove Widget" ng-click=remove() ng-if=editMode><i class="glyphicon glyphicon-remove"></i></a></span></h3><small ng-if=definition.config.filters.count_last_day>Last {{definition.config.filters.count_last_day}} Day</small> <span class=widget_filters_info ng-show=!!definition.config.filters[index.key] ng-repeat="index in [{key:\'os\',title:\'OS\'},{key:\'country\',title:\'Сountry\'},{key:\'device\',title:\'Device\'}]"><small ng-if="!!definition.config.filters[index.key]&& definition.config.filters[index.key]!==\'-\'">&nbsp;{{index.title}}: {{definition.config.filters[index.key]}}&nbsp;</small></span> <span></span>'),t.put("{widgetsPath}/analytics-proxy-traffic/src/views/view-hits-cache-chart.tpl.html","<div class=col-lg-12><div hits-cache-chart filters-sets=config.filters ng-domain=config.domain></div></div>"),t.put("{widgetsPath}/analytics-proxy-traffic/src/views/view-http-https-chart.tpl.html","<div class=col-lg-12><div http-https-chart filters-sets=config.filters ng-domain=config.domain></div></div>"),t.put("{widgetsPath}/analytics-proxy-traffic/src/views/view-http-status-code-chart.tpl.html","<div class=col-lg-12><div http-status-code-chart filters-sets=config.filters status-codes=config.statusCode ng-domain=config.domain></div></div>"),t.put("{widgetsPath}/analytics-proxy-traffic/src/views/view-proxy-traffic-chart.tpl.html","<div class=col-lg-12><div proxy-traffic-chart filters-sets=config.filters status-codes=config.statusCode.labels ng-domain=config.domain></div></div>"),t.put("{widgetsPath}/analytics-proxy-traffic/src/views/view-request-status-chart.tpl.html","<div class=col-lg-12><div request-status-chart status-codes=config.statusCode fl-os=config.os.labels fl-device=config.device.labels fl-country=config.countries ng-domain=config.domain></div></div>"),t.put("{widgetsPath}/analytics-proxy-traffic/src/views/view-requests-chart.tpl.html","<div class=col-lg-12><div requests-chart filters-sets=config.filters ng-domain=config.domain></div></div>"),t.put("{widgetsPath}/analytics-proxy-traffic/src/views/parts/panel-filter-settings.tpl.html","<div ng-show=!!config.filters[index.key] class=col-md-3 ng-repeat=\"index in [{key:'os',title:'OS'},{key:'country',title:'Сountry'},{key:'device',title:'Device'}]\"><small>{{index.title}}: {{config.filters[index.key]}}</small></div>"),t.put("{widgetsPath}/analytics-proxy-traffic/src/views/parts/title-with-filter-params.tpl.html","")}]),angular.module("adf.widget.analytics-proxy-traffic").controller("widgetRequestSuccessFailureRatioCtrl",i),i.$inject=["$scope","config","Countries","Stats"]}(window);